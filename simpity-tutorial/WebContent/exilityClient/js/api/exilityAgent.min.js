var DataCollection=function(){this.values={};this.lists={};this.grids={};this.success=!0;this.messages={};this.TABLE_SEPARATOR=String.fromCharCode(28);this.BODY_SEPARATOR=String.fromCharCode(29);this.ROW_SEPARATOR=String.fromCharCode(30);this.FIELD_SEPARATOR=String.fromCharCode(31);this.VALUES_TABLE_NAME="values";this.SUCCESS_FIELD_NAME="_success";this.MESSAGES_TABLE_NAME="_messages";this.MESSAGE_TYPE_ERROR="error";this.MESSAGE_TYPE_WARN="warning";this.AUTHENTICATION_STATUS="authenticationStatus";
this.TRACE_FIELD_NAME="exilityServerTraceText";this.PERFORMANCE_FIELD_NAME="exilityServerPerformanceText"};DataCollection.prototype.fromDc=function(a){this.success=a.success;this.values=a.values;this.messages=a.messages;this.grids=a.grids;this.lists=a.lists};DataCollection.prototype.addMessage=function(a,b){a=a.toLowerCase();var c=this.messages[a];c&&"undefined"!==typeof c||(c=[],this.messages[a]=c);c.push(b);a==this.MESSAGE_TYPE_ERROR&&(this.success=!1)};
DataCollection.prototype.hasValues=function(){for(var a in this.values)return!0;return!1};DataCollection.prototype.getValue=function(a){return this.values[a]};DataCollection.prototype.hasValue=function(a){return"undefined"!==typeof this.values[a]};DataCollection.prototype.addValue=function(a,b){this.values[a]=b};DataCollection.prototype.removeValue=function(a){var b=this.values[a];delete this.values[a];return b};DataCollection.prototype.getGrid=function(a){return this.grids[a]};
DataCollection.prototype.addGrid=function(a,b){this.grids[a]&&debug("grid "+a+" is already in the dc. It will be replaced with the new grid");this.grids[a]=b};DataCollection.prototype.removeGrid=function(a){var b=this.grids[a];delete this.grids[a];return b};DataCollection.prototype.addList=function(a,b){this.lists[a]=b};DataCollection.prototype.getList=function(a){return this.lists[a]};DataCollection.prototype.removeList=function(a){var b=this.lists[a];delete this.lists[a];return b};
DataCollection.prototype.hasError=function(){return!this.success};DataCollection.prototype.getMessageText=function(){var a="",b;for(b in this.messages)for(var a=b==ClientConstants.MESSATE_TYPE_ERROR?a+"Error\n":a+(b+"\n"),c=this.messages[b],e=0;e<c.length;e++)a+=c[e]+"\n";return a};
DataCollection.prototype.serialize=function(){var a="",b=[this.VALUES_TABLE_NAME,this.BODY_SEPARATOR],c=!0;for(name in this.values)(a=this.values[name])||0==a||(a=""),c?c=!1:b.push(this.ROW_SEPARATOR),b.push(name),b.push(this.FIELD_SEPARATOR),b.push(a);for(var e in this.grids)if(this.grids[e]){var f=this.grids[e];b.push(this.TABLE_SEPARATOR);b.push(e);b.push(this.BODY_SEPARATOR);for(c=0;c<f.length;c++){0!=c&&b.push(this.ROW_SEPARATOR);for(var d=f[c],g=0;g<f[c].length;g++)(a=d[g])||0==a||(a=""),0!=
g&&b.push(this.FIELD_SEPARATOR),b.push(a)}}for(var h in this.lists)if(a=this.lists[h])for(b.push(this.TABLE_SEPARATOR),b.push(h),b.push(this.BODY_SEPARATOR),c=0;c<a.length;c++)0!=c&&b.push(this.ROW_SEPARATOR),b.push(a[c]);return b.join("")};
DataCollection.prototype.deserialize=function(a){a=a.split(this.TABLE_SEPARATOR);for(var b=0;b<a.length;b++){var c=a[b].split(this.BODY_SEPARATOR);if(2==c.length){for(var e=c[0],f=c[1].split(this.ROW_SEPARATOR),c=[],d=0;d<f.length;d++)c.push(f[d].split(this.FIELD_SEPARATOR));if(e==this.VALUES_TABLE_NAME){for(d=1;d<c.length;d++)e=c[d],this.addValue(e[0],e[1]);this.success=(e=this.getValue(this.SUCCESS_FIELD_NAME))&&"1"==e}else if(e==this.MESSAGES_TABLE_NAME)for(d=1;d<c.length;d++)e=c[d],this.addMessage(e[0],
e[1]);else this.addGrid(e,c)}}};
DataCollection.prototype.fromElement=function(a){for(var b=a.getElementsByTagName("input"),c=b.length,e,f,d=null,g=0;g<c;g++)if(d=b[g],e=d.name||d.id){f=d.type?d.type.toLowerCase():"text";if("text"!=f){if("button"===f||"reset"==f||"submit"===f||"image"==f||"file"===f)continue;if(("radio"==f||"checkbox"==f)&&!d.checked)continue}f=d.value;this.hasValue(e)&&(f=this.getValue(e)+","+f);this.addValue(e,f)}b=a.getElementsByTagName("select");c=b.length;for(g=0;g<c;g++)if(d=b[g],e=d.id||d.name){a=d.childNodes;
f=null;if(d.multiple)for(d=0;d<a.length;d++){var h=a[d];a.selected&&(f=f?f+(","+h.value):h.value)}else if(d.selectedIndex||0==d.selectedIndex)f=a[d.selectedIndex].value;null!=f&&this.addValue(e,f)}};DataCollection.prototype.toHtml=function(){var a=[];this.messagesToHtml(a);this.valuesToHtml(a);this.gridsToHtml(a);this.listsToHtml(a);return a.join("")};
DataCollection.prototype.messagesToHtml=function(a){var b=!1,c;for(c in this.messages){b=!0;a.push("\x3cbr/\x3e");a.push(c);a.push("\x3cbr/\x3e");var e="\x3c/font\x3e";c===this.MESSAGE_TYPE_ERROR?a.push('\x3cfont color\x3d"red"\x3e'):c===this.MESSAGE_TYPE_WARN?a.push('\x3cfont color\x3d"blue"\x3e'):e="";for(var f=this.messages[c],d=0;d<f.length;d++)a.push(f[d]+"\x3cbr/\x3e");a.push(e)}b||a.push("\x3cbr/\x3eThere are no messages\x3cbr/\x3e")};
DataCollection.prototype.valuesToHtml=function(a){a.push("\x3cbr/\x3eValues are :\x3cbr/\x3e");a.push('\x3ctable border\x3d"1"\x3e\x3ctr\x3e\x3cth\x3eVariable\x3c/th\x3e\x3cth\x3eValue\x3c/th\x3e\x3c/tr\x3e');for(var b in this.values)b!=this.TRACE_FIELD_NAME&&b!=this.PERFORMANCE_FIELD_NAME&&(a.push("\x3ctr\x3e\x3ctd\x3e"),a.push(b),a.push("\x3c/td\x3e\x3ctd\x3e"),a.push(this.values[b]),a.push("\x3c/td\x3e\x3c/tr\x3e"));a.push("\x3c/table\x3e")};
DataCollection.prototype.gridsToHtml=function(a){var b=!1,c;for(c in this.grids){var e=this.grids[c];if(e){b||(a.push("\x3cbr/\x3eGrids are:"),b=!0);a.push("\x3cbr/\x3e");var f=e.length,d=f&&e[0].length;a.push(c);a.push(" has ");if(d){a.push(f-1);a.push(" data rows and ");a.push(d);a.push(' columns\x3cbr/\x3e\x3ctable border\x3d"1"\x3e\x3ctr\x3e');for(var g=e[0],h=0;h<d;h++)a.push("\x3cth\x3e"),a.push(g[h]),a.push("\x3c/th\x3e");a.push("\x3c/tr\x3e");for(g=1;g<f;g++){a.push("\x3ctr\x3e");for(var l=
e[g],h=0;h<d;h++)a.push("\x3ctd\x3e"),a.push(l[h]||"\x26nbsp;"),a.push("\x3c/td\x3e");a.push("\x3c/tr\x3e")}a.push("\x3c/table\x3e")}else a.push(" no data.")}}};
DataCollection.prototype.listsToHtml=function(a){var b=!1,c;for(c in this.lists){var e=this.lists[c];e&&(b||(a.push('\x3cbr/\x3eLists are:\x3cbr/\x3e\x3ctable border\x3d"1" cellpadding\x3d"0" cellspacing\x3d"2"\x3e\x3ctr\x3e\x3cth\x3eList Name\x3c/th\x3e\x3cth\x3eValues\x3c/th\x3e\x3c/tr\x3e'),b=!0),a.push("\x3ctr\x3e\x3ctd\x3e"),a.push(c),a.push("\x3c/td\x3e\x3ctd\x3e"),a.push(e),a.push("\x3c/td\x3e\x3c/tr\x3e"))}b&&a.push("\x3c/table\x3e")};
var ExilityAgent=function(){var a=null,a=window.debug?window.debug:window.logger&&window.logger.trace?window.logger:function(){},b=null,b=window.message?window.message:window.alert,c={serviceFailed:function(a,c){b("ERROR : Agent reported an error with code \x3d "+a+" and msg \x3d "+c)},serviceReturned:function(b){a("Call to server succeded.")}},e=12E4,f={},d=1,g=null,h=function(){4==this.readyState&&ExilityAgent.serviceReturned(this)};return{ERROR_NO_URL:1,ERROR_CONNECTION_ERROR:2,ERRROR_HTTP_ERROR:3,
ERROR_TIMED_OUT:4,ERROR_INVALID_RESPONSE:5,ERROR_SESSION_EXPIRED:6,ERROR_NOT_LOGGED_IN:7,ERROR_SERVER_ERROR:8,setTimeout:function(a){(a=parseInt(a))&&(e=1E3*a)},setUrl:function(a){url=a},serve:function(l,n,p,m,q){if(!n)n=c;else if(!n.serviceReturned||!n.serviceFailed)return b("Callback object provided for serve() must have method serviceReturned(dc) for handling data returned from server, and serviceFailed(errorCode, errorMessage) to handle error. If you do not want to do any of these, pass null as callBackObject."),
null;if(url){a("Received a request for service "+l);p?a("Data to be sent to serve\n"+p.toHtml(),!0):p=new DataCollection;p.addValue("serviceId",l);p=p.serialize();var k=new XMLHttpRequest;k.startedAt=new Date;k.serviceId=l;k.callBackObject=n;l=k.reqId=d;f[l]=k;d++;k.timerHandle=setTimeout("ExilityAgent.timedOut("+l+")",e);m||(k.onreadystatechange=h);try{k.open(q&&q.requestMethod||"POST",url,!m),k.setRequestHeader("Content-Type",q&&q.contentType||"text/html; charset\x3dutf-8"),g&&k.setRequestHeader("X-CSRF-Token",
g),k.send(p)}catch(r){return m="Error while requesting for url "+url+". "+r,a(m),n.serviceFailed(ERROR_CONNECTION_ERROR,m),null}if(m)serviceReturned(k);else return l}else m="Design error: url for server is not set before requesting a service",a(m),n.serviceFailed(ERROR_NO_URL,m)},cancel:function(b){var c=f[b];if(!c)return a(b+" is not a valid handle to a service request."),!1;clearTimeout(c.timerHandle);c.gotCancelled=!0;c.timerHandle=null;delete f[b];a("Service request for "+c.serviceId+" was cancelled by caller.");
return!0},timedOut:function(b){var c=f[b];if(!c)return a("Design error: timedOut called with "+b+" which is not a valid inidex to a service call."),!1;c.timerHandle=null;delete f[b];b="Request to url "+url+" for service "+c.serviceId+" did not return within "+e/1E3+" seconds. Giving-up.";a(b);c.callBackObject.serviceFailed(ERROR_TIMED_OUT,b);return!0},serviceReturned:function(b){if(!b.timerHandle)return a(b.serviceId+" did come back,"+b.gotCancelled?" but caller had already cancelled it.":"but too late to avoid a time-out."),
!1;clearTimeout(b.timerHandle);b.timerHandle=null;delete f[b.reqId];if(200>b.status||300<=b.status){var c="Http Error: Request for service "+b.serviceId+" failed with status : "+b.status+" - "+b.statusText;a(c);b.callBackObject.serviceFailed(ExilityAgent.HTTP_ERROR,c);return!1}var d=b.responseText,c=new DataCollection;if(0<d.length)try{0<=d.substr(0,15).indexOf("var dc \x3d ")?(eval(d),c.fromDc(dc)):c.deserialize(d)}catch(e){return c="Error while evaluating data returned by server. "+e,a(c),a("Text recd from server:"),
a(d,!0),b.callBackObject.serviceFailed(ERROR_INVALID_RESPONSE,c),!1}if((d=c.getValue(c.AUTHENTICATION_STATUS))&&"0"!=d){if("1"==d)return c="Session expired",a(c),b.callbackObject.serviceFailed(ERROR_SESSION_EXPIRED,c),!1;c="Authentication failed. May be you are not logged-in.";a(c);b.callbackObject.serviceFailed(ERROR_NOT_LOGGED_IN,c);return!1}(d=b.getResponseHeader("X-CSRF-Token"))&&(g="remove"===d?null:d);a("Time taken for service "+b.serviceId+" : "+(new Date-b.startedAt)+" ticks.");if(d=c.removeValue(c.PERFORMANCE_FIELD_NAME))a("Server Performance : "),
a(d);if(d=c.removeValue(c.TRACE_FIELD_NAME))a("******* begin trace from server ********"),a(d),a("******* end server trace ********");a("Data returned:");c.addValue("serviceId",b.serviceId);a(c.toHtml(),!0);b.callBackObject.serviceReturned(c);return!0}}}();